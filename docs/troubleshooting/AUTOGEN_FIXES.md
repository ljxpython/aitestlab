# AutoGen æœåŠ¡é—®é¢˜ä¿®å¤è¯´æ˜

[â† è¿”å›ä¸»æ–‡æ¡£](../../README.md) | [ğŸ“– æ–‡æ¡£ä¸­å¿ƒ](../) | [ğŸ“‹ å¯¼èˆªç´¢å¼•](../DOCS_INDEX.md)

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [æ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—](../development/LOGGING_GUIDE.md) - æ—¥å¿—æŸ¥çœ‹å’Œè°ƒè¯•
- [å·¥å‚æ¨¡å¼æ¶æ„è¯´æ˜](../setup/FACTORY_PATTERN.md) - åç«¯æ¶æ„ç†è§£

## ğŸ› ä¿®å¤çš„é—®é¢˜

### 1. Agent åç§°é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
```
The agent name must be a valid Python identifier.
```

**åŸå› åˆ†æ**ï¼š
- AutoGen è¦æ±‚ Agent åç§°å¿…é¡»æ˜¯æœ‰æ•ˆçš„ Python æ ‡è¯†ç¬¦
- UUID ä¸­åŒ…å«è¿å­—ç¬¦ `-`ï¼Œä¸ç¬¦åˆ Python æ ‡è¯†ç¬¦è§„èŒƒ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
# ä¿®å¤å‰
name=f"assistant_{conversation_id}"  # conversation_id åŒ…å«è¿å­—ç¬¦

# ä¿®å¤å
safe_name = f"assistant_{conversation_id.replace('-', '_')}"
```

### 2. å†…å­˜æ³„æ¼é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- Agent å¯¹è±¡ä¼šä¸€ç›´ç´¯ç§¯åœ¨å†…å­˜ä¸­
- æ²¡æœ‰æ¸…ç†æœºåˆ¶ï¼Œé•¿æ—¶é—´è¿è¡Œä¼šå¯¼è‡´å†…å­˜è€—å°½

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ·»åŠ è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- åŸºäºæ—¶é—´çš„ TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰
- åŸºäºæ•°é‡çš„å®¹é‡é™åˆ¶
- å®šæœŸæ¸…ç†è¿‡æœŸ Agent

## ğŸ”§ å®ç°çš„åŠŸèƒ½

### 1. Agent ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
self.agents[conversation_id] = {
    'agent': agent,
    'created_at': asyncio.get_event_loop().time(),
    'last_used': asyncio.get_event_loop().time()
}
```

**ç‰¹æ€§**ï¼š
- è®°å½•åˆ›å»ºæ—¶é—´
- è®°å½•æœ€åä½¿ç”¨æ—¶é—´
- æ”¯æŒ TTL è¿‡æœŸæ¸…ç†

### 2. è‡ªåŠ¨æ¸…ç†æœºåˆ¶

**æ¸…ç†ç­–ç•¥**ï¼š
1. **æ—¶é—´æ¸…ç†**ï¼šæ¸…ç†è¶…è¿‡ TTL çš„ Agent
2. **å®¹é‡æ¸…ç†**ï¼šè¶…è¿‡æœ€å¤§æ•°é‡æ—¶æ¸…ç†æœ€æ—§çš„ Agent
3. **å®šæœŸæ£€æŸ¥**ï¼šæ¯æ¬¡èŠå¤©æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†

**é…ç½®å‚æ•°**ï¼š
```yaml
# backend/conf/settings.yaml
autogen:
  max_agents: 100        # æœ€å¤§ Agent æ•°é‡
  cleanup_interval: 3600 # æ¸…ç†æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
  agent_ttl: 7200       # Agent ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰
```

### 3. ç›‘æ§å’Œç®¡ç† API

#### è·å–ç»Ÿè®¡ä¿¡æ¯
```http
GET /api/chat/stats
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "total_agents": 15,
  "active_agents": 12,
  "expired_agents": 3,
  "max_agents": 100,
  "agent_ttl": 7200,
  "cleanup_interval": 3600
}
```

#### å¼ºåˆ¶æ¸…ç†
```http
POST /api/chat/cleanup
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "message": "æ¸…ç†å®Œæˆ",
  "stats": {
    "total_agents": 10,
    "active_agents": 10,
    "expired_agents": 0
  }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ä½¿ç”¨ä¼˜åŒ–

**ä¼˜åŒ–å‰**ï¼š
- Agent å¯¹è±¡æ— é™ç´¯ç§¯
- å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿
- å¯èƒ½å¯¼è‡´ OOM

**ä¼˜åŒ–å**ï¼š
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸ Agent
- å®¹é‡é™åˆ¶ä¿æŠ¤
- å†…å­˜ä½¿ç”¨ç¨³å®š

### 2. æ¸…ç†æ€§èƒ½

**æ¸…ç†ç®—æ³•**ï¼š
```python
def _cleanup_expired_agents(self):
    """æ¸…ç†è¿‡æœŸçš„ Agent"""
    current_time = asyncio.get_event_loop().time()
    expired_ids = []

    for conv_id, agent_info in self.agents.items():
        if current_time - agent_info['last_used'] > self.agent_ttl:
            expired_ids.append(conv_id)

    for conv_id in expired_ids:
        del self.agents[conv_id]
```

**ç‰¹ç‚¹**ï¼š
- O(n) æ—¶é—´å¤æ‚åº¦
- æ‰¹é‡åˆ é™¤ï¼Œå‡å°‘å­—å…¸æ“ä½œ
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æ—¥å¿—è®°å½•

**Agent åˆ›å»º**ï¼š
```
2025-06-05 19:53:07 | INFO | AutoGen æœåŠ¡åˆå§‹åŒ– | æœ€å¤§Agentæ•°: 100 | TTL: 7200s
2025-06-05 19:53:07 | SUCCESS | Agent åˆ›å»ºæˆåŠŸ | å¯¹è¯ID: abc123 | åç§°: assistant_abc123_def456
```

**è‡ªåŠ¨æ¸…ç†**ï¼š
```
2025-06-05 19:53:07 | INFO | æ¸…ç†è¿‡æœŸ Agent | å¯¹è¯ID: old_conversation
2025-06-05 19:53:07 | INFO | æ¸…ç†å®Œæˆ | æ¸…ç†æ•°é‡: 5 | å‰©ä½™æ•°é‡: 95
```

### 2. ç»Ÿè®¡ç›‘æ§

**å®æ—¶ç›‘æ§**ï¼š
```bash
# æŸ¥çœ‹ Agent ç»Ÿè®¡
curl http://localhost:8000/api/chat/stats

# å¼ºåˆ¶æ¸…ç†
curl -X POST http://localhost:8000/api/chat/cleanup
```

## âš™ï¸ é…ç½®è¯´æ˜

### é»˜è®¤é…ç½®

```python
max_agents = 100        # æœ€å¤§ Agent æ•°é‡
cleanup_interval = 3600 # æ¸…ç†æ£€æŸ¥é—´éš”ï¼ˆ1å°æ—¶ï¼‰
agent_ttl = 7200       # Agent ç”Ÿå­˜æ—¶é—´ï¼ˆ2å°æ—¶ï¼‰
```

### é…ç½®å»ºè®®

**å¼€å‘ç¯å¢ƒ**ï¼š
```yaml
autogen:
  max_agents: 10
  cleanup_interval: 300   # 5åˆ†é’Ÿ
  agent_ttl: 1800        # 30åˆ†é’Ÿ
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
```yaml
autogen:
  max_agents: 500
  cleanup_interval: 3600  # 1å°æ—¶
  agent_ttl: 14400       # 4å°æ—¶
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. é…ç½®è°ƒä¼˜

- **max_agents**: æ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´
- **agent_ttl**: æ ¹æ®ç”¨æˆ·ä¼šè¯æ—¶é•¿è°ƒæ•´
- **cleanup_interval**: å¹³è¡¡æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨

### 2. ç›‘æ§å»ºè®®

- å®šæœŸæ£€æŸ¥ Agent ç»Ÿè®¡ä¿¡æ¯
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- å…³æ³¨æ¸…ç†æ—¥å¿—

### 3. æ•…éšœæ’é™¤

**å†…å­˜æŒç»­å¢é•¿**ï¼š
- æ£€æŸ¥ TTL é…ç½®æ˜¯å¦åˆç†
- ç¡®è®¤æ¸…ç†æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
- è€ƒè™‘é™ä½ max_agents

**Agent åˆ›å»ºå¤±è´¥**ï¼š
- æ£€æŸ¥åç§°ç”Ÿæˆé€»è¾‘
- ç¡®è®¤ UUID æ ¼å¼æ­£ç¡®
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å†…å­˜ä½¿ç”¨

**ä¼˜åŒ–å‰**ï¼š
- æ¯ä¸ª Agent çº¦ 1-5MB
- æ— æ¸…ç†æœºåˆ¶ï¼ŒæŒç»­å¢é•¿

**ä¼˜åŒ–å**ï¼š
- è‡ªåŠ¨æ¸…ç†ï¼Œå†…å­˜ç¨³å®š
- å¯é…ç½®çš„å®¹é‡ä¸Šé™

### å“åº”æ—¶é—´

**æ¸…ç†æ“ä½œ**ï¼š
- è¿‡æœŸæ¸…ç†ï¼šO(n)ï¼Œé€šå¸¸ < 10ms
- å®¹é‡æ¸…ç†ï¼šO(n log n)ï¼Œé€šå¸¸ < 50ms

**å¯¹èŠå¤©çš„å½±å“**ï¼š
- æ¸…ç†æ“ä½œå¼‚æ­¥æ‰§è¡Œ
- å¯¹ç”¨æˆ·ä½“éªŒæ— å½±å“

## ğŸ”„ åç»­ä¼˜åŒ–

### 1. å¯èƒ½çš„æ”¹è¿›

- ä½¿ç”¨ LRU ç¼“å­˜ç®—æ³•
- æ·»åŠ  Agent é¢„çƒ­æœºåˆ¶
- å®ç°åˆ†å¸ƒå¼ Agent ç®¡ç†

### 2. ç›‘æ§å¢å¼º

- æ·»åŠ  Prometheus æŒ‡æ ‡
- é›†æˆ Grafana ä»ªè¡¨æ¿
- è®¾ç½®å‘Šè­¦é˜ˆå€¼

---

âœ… **ä¿®å¤å®Œæˆ**ï¼šAgent åç§°é—®é¢˜å’Œå†…å­˜æ³„æ¼é—®é¢˜å·²å…¨éƒ¨è§£å†³ï¼Œç³»ç»Ÿç°åœ¨å¯ä»¥ç¨³å®šé•¿æœŸè¿è¡Œï¼
