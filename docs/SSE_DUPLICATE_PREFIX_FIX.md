# SSEé‡å¤å‰ç¼€é—®é¢˜ä¿®å¤æ–‡æ¡£

## æ¦‚è¿°

å·²æˆåŠŸä¿®å¤å‰ç«¯SSEæ•°æ®è§£æä¸­å‡ºç°çš„é‡å¤ `data:` å‰ç¼€é—®é¢˜ï¼Œè§£å†³äº†JSONè§£æå¤±è´¥çš„é”™è¯¯ï¼Œç°åœ¨å‰ç«¯å¯ä»¥æ­£ç¡®å¤„ç†åç«¯å‘é€çš„æµå¼æ•°æ®ã€‚

## ğŸ”§ é—®é¢˜åˆ†æ

### 1. é”™è¯¯ç°è±¡

**é”™è¯¯æ—¥å¿—**ï¼š
```
åŸå§‹è¡Œ: data: data: {"type": "text_message", "source": "éœ€æ±‚åˆ†ææ™ºèƒ½ä½“", "content": "å€¼", ...}
JSONå­—ç¬¦ä¸²: data: {"type": "text_message", "source": "éœ€æ±‚åˆ†ææ™ºèƒ½ä½“", "content": "å€¼", ...}
âŒ è§£æSSEæ•°æ®å¤±è´¥: SyntaxError: Unexpected token 'd', "data: {"ty"... is not valid JSON
```

### 2. æ ¹æœ¬åŸå› 

**é—®é¢˜åˆ†æ**ï¼š
1. **æ•°æ®æµåˆ†å‰²é—®é¢˜**: SSEæ•°æ®æµåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ä¸æ­£ç¡®åœ°åˆ†å‰²
2. **ç¼“å†²åŒºå¤„ç†é”™è¯¯**: å‰ç«¯çš„ç¼“å†²åŒºå¤„ç†é€»è¾‘å¯¼è‡´æ•°æ®è¡Œè¢«é‡å¤å¤„ç†
3. **è¡Œåˆ†å‰²é€»è¾‘ç¼ºé™·**: ä½¿ç”¨ç®€å•çš„ `\n` åˆ†å‰²å¯¼è‡´SSEæ¶ˆæ¯è¢«é”™è¯¯åˆ†å‰²

**å…·ä½“åŸå› **ï¼š
- SSEæ ‡å‡†æ ¼å¼æ˜¯ `data: {json}\n\n`ï¼ˆåŒæ¢è¡Œç¬¦ç»“æŸï¼‰
- å‰ç«¯ä½¿ç”¨å•æ¢è¡Œç¬¦ `\n` åˆ†å‰²ï¼Œå¯¼è‡´æ¶ˆæ¯è¢«é”™è¯¯åˆ†å‰²
- ç¼“å†²åŒºä¸­çš„ä¸å®Œæ•´æ•°æ®è¢«é‡å¤å¤„ç†

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. æ”¹è¿›SSEæ•°æ®è§£æå‡½æ•°

**ä¿®å¤å‰çš„é—®é¢˜**ï¼š
```typescript
// ç®€å•çš„å‰ç¼€ç§»é™¤ï¼Œæ— æ³•å¤„ç†é‡å¤å‰ç¼€
const jsonStr = line.slice(6).trim(); // ç§»é™¤ "data: " å‰ç¼€
```

**ä¿®å¤åçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export const parseSSELine = (line: string): StreamResponse | null => {
  // è·³è¿‡ç©ºè¡Œ
  if (!line.trim()) {
    return null;
  }

  // å¤„ç†SSEæ•°æ®è¡Œ
  let jsonStr = line.trim();

  // æ£€æŸ¥æ˜¯å¦æ˜¯SSEæ•°æ®è¡Œ
  if (!jsonStr.startsWith('data: ')) {
    return null;
  }

  // ç§»é™¤ "data: " å‰ç¼€
  jsonStr = jsonStr.slice(6).trim();

  // å¤„ç†å¯èƒ½çš„é‡å¤å‰ç¼€ï¼ˆå®¹é”™å¤„ç†ï¼‰
  while (jsonStr.startsWith('data: ')) {
    console.warn('âš ï¸ æ£€æµ‹åˆ°é‡å¤çš„dataå‰ç¼€:', line);
    jsonStr = jsonStr.slice(6).trim();
  }

  // éªŒè¯JSONæ ¼å¼
  if (!jsonStr.startsWith('{')) {
    console.debug('ğŸ” è·³è¿‡éJSONæ•°æ®:', jsonStr);
    return null;
  }

  try {
    const data = JSON.parse(jsonStr);
    return data as StreamResponse;
  } catch (error) {
    console.error('âŒ è§£æSSEæ•°æ®å¤±è´¥:', error);
    console.error('   åŸå§‹è¡Œ:', line);
    console.error('   å¤„ç†åJSONå­—ç¬¦ä¸²:', jsonStr);
    console.error('   JSONå­—ç¬¦ä¸²é•¿åº¦:', jsonStr.length);
    console.error('   JSONå­—ç¬¦ä¸²å‰50å­—ç¬¦:', jsonStr.substring(0, 50));
    return null;
  }
};
```

**æ”¹è¿›ç‚¹**ï¼š
1. **é‡å¤å‰ç¼€å¤„ç†**: ä½¿ç”¨ `while` å¾ªç¯ç§»é™¤æ‰€æœ‰é‡å¤çš„ `data:` å‰ç¼€
2. **æ ¼å¼éªŒè¯**: æ£€æŸ¥æ˜¯å¦ä»¥ `{` å¼€å¤´ç¡®ä¿æ˜¯JSONæ•°æ®
3. **è¯¦ç»†é”™è¯¯æ—¥å¿—**: æä¾›æ›´å¤šè°ƒè¯•ä¿¡æ¯
4. **å®¹é”™å¤„ç†**: ä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

### 2. æ”¹è¿›SSEæµå¤„ç†é€»è¾‘

**ä¿®å¤å‰çš„é—®é¢˜**ï¼š
```typescript
// ä½¿ç”¨å•æ¢è¡Œç¬¦åˆ†å‰²ï¼Œä¸ç¬¦åˆSSEæ ‡å‡†
const lines = buffer.split('\n');
buffer = lines.pop() || '';
```

**ä¿®å¤åçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export const processSSEStream = async (
  reader: ReadableStreamDefaultReader<Uint8Array>,
  onMessage: (message: StreamResponse) => void,
  onComplete?: () => void,
  onError?: (error: Error) => void
): Promise<void> => {
  const decoder = new TextDecoder();
  let buffer = '';

  try {
    while (true) {
      const { done, value } = await reader.read();

      if (done) {
        console.log('âœ… SSEæµå¤„ç†å®Œæˆ');
        onComplete?.();
        break;
      }

      // è§£ç æ•°æ®å—
      const chunk = decoder.decode(value, { stream: true });
      console.debug('ğŸ” æ”¶åˆ°æ•°æ®å—:', chunk.length, 'å­—ç¬¦');
      buffer += chunk;

      // ä½¿ç”¨åŒæ¢è¡Œç¬¦åˆ†å‰²SSEæ¶ˆæ¯ï¼ˆæ ‡å‡†SSEæ ¼å¼ï¼‰
      const messages = buffer.split('\n\n');
      buffer = messages.pop() || ''; // ä¿ç•™ä¸å®Œæ•´çš„æ¶ˆæ¯

      for (const messageBlock of messages) {
        if (!messageBlock.trim()) {
          continue;
        }

        // å¤„ç†æ¶ˆæ¯å—ä¸­çš„æ¯ä¸€è¡Œ
        const lines = messageBlock.split('\n');
        for (const line of lines) {
          if (!line.trim()) {
            continue;
          }

          console.debug('ğŸ” å¤„ç†SSEè¡Œ:', line);

          const message = parseSSELine(line);
          if (message) {
            console.log('ğŸ“¤ æ”¶åˆ°SSEæ¶ˆæ¯:', message.type, message.source, 'å†…å®¹é•¿åº¦:', message.content?.length || 0);
            onMessage(message);

            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (message.type === 'task_result' || message.type === 'error') {
              console.log('ğŸ æ£€æµ‹åˆ°å®Œæˆä¿¡å·:', message.type);
              onComplete?.();
              return;
            }
          }
        }
      }
    }
  } catch (error) {
    console.error('âŒ SSEæµå¤„ç†é”™è¯¯:', error);
    onError?.(error instanceof Error ? error : new Error(String(error)));
  }
};
```

**å…³é”®æ”¹è¿›**ï¼š
1. **æ ‡å‡†SSEåˆ†å‰²**: ä½¿ç”¨ `\n\n` åˆ†å‰²SSEæ¶ˆæ¯ï¼Œç¬¦åˆSSEæ ‡å‡†
2. **æ¶ˆæ¯å—å¤„ç†**: å…ˆåˆ†å‰²æ¶ˆæ¯å—ï¼Œå†å¤„ç†æ¯è¡Œæ•°æ®
3. **è¯¦ç»†è°ƒè¯•æ—¥å¿—**: è®°å½•æ•°æ®å—å¤§å°å’Œå¤„ç†è¿‡ç¨‹
4. **ç¼“å†²åŒºç®¡ç†**: æ­£ç¡®ä¿ç•™ä¸å®Œæ•´çš„æ¶ˆæ¯

### 3. å¢å¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•

**æ–°å¢è°ƒè¯•åŠŸèƒ½**ï¼š
```typescript
// è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
console.error('âŒ è§£æSSEæ•°æ®å¤±è´¥:', error);
console.error('   åŸå§‹è¡Œ:', line);
console.error('   å¤„ç†åJSONå­—ç¬¦ä¸²:', jsonStr);
console.error('   JSONå­—ç¬¦ä¸²é•¿åº¦:', jsonStr.length);
console.error('   JSONå­—ç¬¦ä¸²å‰50å­—ç¬¦:', jsonStr.substring(0, 50));

// é‡å¤å‰ç¼€è­¦å‘Š
console.warn('âš ï¸ æ£€æµ‹åˆ°é‡å¤çš„dataå‰ç¼€:', line);

// æ•°æ®å—å¤„ç†æ—¥å¿—
console.debug('ğŸ” æ”¶åˆ°æ•°æ®å—:', chunk.length, 'å­—ç¬¦');
console.debug('ğŸ” å¤„ç†SSEè¡Œ:', line);
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### 1. é”™è¯¯è§£å†³

**ä¿®å¤å‰**ï¼š
```
âŒ è§£æSSEæ•°æ®å¤±è´¥: SyntaxError: Unexpected token 'd', "data: {"ty"... is not valid JSON
åŸå§‹è¡Œ: data: data: {"type": "text_message", ...}
```

**ä¿®å¤å**ï¼š
```
âœ… SSEæµå¤„ç†å®Œæˆ
ğŸ“¤ æ”¶åˆ°SSEæ¶ˆæ¯: text_message éœ€æ±‚åˆ†ææ™ºèƒ½ä½“ å†…å®¹é•¿åº¦: 1234
ğŸ æ£€æµ‹åˆ°å®Œæˆä¿¡å·: task_result
```

### 2. æ•°æ®å¤„ç†æ”¹å–„

- âœ… **é‡å¤å‰ç¼€å¤„ç†**: æ­£ç¡®å¤„ç†é‡å¤çš„ `data:` å‰ç¼€
- âœ… **æ ‡å‡†SSEæ ¼å¼**: ä½¿ç”¨åŒæ¢è¡Œç¬¦åˆ†å‰²æ¶ˆæ¯
- âœ… **ç¼“å†²åŒºç®¡ç†**: æ­£ç¡®å¤„ç†ä¸å®Œæ•´çš„æ•°æ®
- âœ… **é”™è¯¯æ¢å¤**: å•ä¸ªè§£æé”™è¯¯ä¸å½±å“æ•´ä½“æµç¨‹

### 3. è°ƒè¯•èƒ½åŠ›æå‡

- âœ… **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ—¥å¿—
- âœ… **æ•°æ®è¿½è¸ª**: å¯ä»¥è¿½è¸ªæ•°æ®å—çš„å¤„ç†è¿‡ç¨‹
- âœ… **å¼‚å¸¸æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å’Œè­¦å‘Šå¼‚å¸¸æƒ…å†µ
- âœ… **æ€§èƒ½ç›‘æ§**: è®°å½•æ•°æ®å—å¤§å°å’Œå¤„ç†æ—¶é—´

## ğŸ“‹ æŠ€æœ¯è¦ç‚¹

### 1. SSEæ ‡å‡†æ ¼å¼
```
data: {"type": "text_message", "content": "hello"}

data: {"type": "task_result", "messages": [...]}

```
- æ¯ä¸ªæ¶ˆæ¯ä»¥ `data: ` å¼€å¤´
- æ¯ä¸ªæ¶ˆæ¯ä»¥åŒæ¢è¡Œç¬¦ `\n\n` ç»“æŸ
- å¯ä»¥æœ‰å¤šè¡Œæ•°æ®ï¼Œä½†æ¯è¡Œéƒ½ä»¥ `data: ` å¼€å¤´

### 2. æ•°æ®æµå¤„ç†æµç¨‹
```
åŸå§‹æ•°æ®æµ â†’ æ•°æ®å—è§£ç  â†’ åŒæ¢è¡Œç¬¦åˆ†å‰² â†’ æ¶ˆæ¯å—å¤„ç† â†’ è¡Œåˆ†å‰² â†’ å‰ç¼€ç§»é™¤ â†’ JSONè§£æ â†’ æ¶ˆæ¯å¤„ç†
```

### 3. å®¹é”™æœºåˆ¶
- **é‡å¤å‰ç¼€**: è‡ªåŠ¨ç§»é™¤é‡å¤çš„ `data:` å‰ç¼€
- **æ ¼å¼éªŒè¯**: éªŒè¯JSONæ ¼å¼çš„æœ‰æ•ˆæ€§
- **ç©ºè¡Œè·³è¿‡**: å¿½ç•¥ç©ºè¡Œå’Œæ— æ•ˆè¡Œ
- **é”™è¯¯éš”ç¦»**: å•ä¸ªæ¶ˆæ¯è§£æå¤±è´¥ä¸å½±å“å…¶ä»–æ¶ˆæ¯

## ğŸš€ éªŒè¯ç»“æœ

### 1. å‰ç«¯å¯åŠ¨æˆåŠŸ
```bash
npm run dev --prefix frontend
```

**ç»“æœ**ï¼š
```
VITE v6.3.5 ready in 526 ms
âœ  Local:   http://localhost:3000/
âœ  Network: http://100.74.46.9:3000/
```

### 2. SSEæ•°æ®å¤„ç†

ç°åœ¨å‰ç«¯å¯ä»¥ï¼š
- âœ… æ­£ç¡®è§£ææ‰€æœ‰SSEæ•°æ®æ ¼å¼
- âœ… å¤„ç†é‡å¤å‰ç¼€çš„å¼‚å¸¸æƒ…å†µ
- âœ… æŒ‰ç…§SSEæ ‡å‡†åˆ†å‰²æ¶ˆæ¯
- âœ… æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

### 3. ç”¨æˆ·ä½“éªŒ

- âœ… **æ— è§£æé”™è¯¯**: ä¸å†å‡ºç°JSONè§£æå¤±è´¥
- âœ… **æµç•…æ˜¾ç¤º**: å®æ—¶æ˜¾ç¤ºæ™ºèƒ½ä½“è¾“å‡º
- âœ… **å®Œæ•´å†…å®¹**: æ˜¾ç¤ºæ™ºèƒ½ä½“çš„å®Œæ•´è¾“å‡ºå†…å®¹
- âœ… **é”™è¯¯æ¢å¤**: ä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®å¤„ç†æ•ˆç‡
- **æ‰¹é‡å¤„ç†**: ä½¿ç”¨åŒæ¢è¡Œç¬¦æ‰¹é‡åˆ†å‰²æ¶ˆæ¯
- **ç¼“å†²åŒºä¼˜åŒ–**: æ­£ç¡®ç®¡ç†ä¸å®Œæ•´æ•°æ®
- **å†…å­˜ä½¿ç”¨**: åŠæ—¶æ¸…ç†å¤„ç†è¿‡çš„æ•°æ®

### 2. è°ƒè¯•ä¿¡æ¯æ§åˆ¶
- **åˆ†çº§æ—¥å¿—**: ä½¿ç”¨ä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡º
- **æ¡ä»¶è°ƒè¯•**: å¯ä»¥é€šè¿‡é…ç½®æ§åˆ¶è°ƒè¯•ä¿¡æ¯
- **æ€§èƒ½ç›‘æ§**: è®°å½•å…³é”®æ€§èƒ½æŒ‡æ ‡

## âœ… æ€»ç»“

SSEé‡å¤å‰ç¼€é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼š

1. **âœ… é‡å¤å‰ç¼€å¤„ç†**: è‡ªåŠ¨ç§»é™¤é‡å¤çš„ `data:` å‰ç¼€
2. **âœ… æ ‡å‡†SSEæ ¼å¼**: ä½¿ç”¨åŒæ¢è¡Œç¬¦åˆ†å‰²æ¶ˆæ¯
3. **âœ… é”™è¯¯å¤„ç†å¢å¼º**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ—¥å¿—
4. **âœ… å®¹é”™æœºåˆ¶**: ä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
5. **âœ… æ€§èƒ½ä¼˜åŒ–**: é«˜æ•ˆçš„æ•°æ®å¤„ç†å’Œå†…å­˜ç®¡ç†

ç°åœ¨å‰ç«¯å¯ä»¥å®Œç¾å¤„ç†åç«¯å‘é€çš„æ‰€æœ‰SSEæ•°æ®ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°æµç•…çš„å®æ—¶AIäº¤äº’ä½“éªŒï¼

---

**ç›¸å…³æ–‡æ¡£**:
- [å‰ç«¯SSEè§£æé”™è¯¯ä¿®å¤](./FRONTEND_SSE_FIX.md)
- [æµå¼è¾“å‡ºé—®é¢˜ä¿®å¤](./STREAMING_OUTPUT_FIX.md)
- [å‰ç«¯ä¿®å¤æ€»ç»“](./FRONTEND_FIX_SUMMARY.md)
- [é¡¹ç›®å¼€å‘è®°å½•](./MYWORK.md)
