# LlamaIndexæ–‡ä»¶è§£æžä¼˜åŒ–æ–‡æ¡£

## æ¦‚è¿°

å·²æˆåŠŸä½¿ç”¨ LlamaIndex ä¼˜åŒ–äº† `RequirementAnalysisAgent` ä¸­çš„æ–‡ä»¶è¯»å–è§£æžåŠŸèƒ½ã€‚é€šè¿‡ `SimpleDirectoryReader` å’Œ `Document` ç±»ï¼Œå®žçŽ°äº†å¯¹å¤šç§æ–‡ä»¶æ ¼å¼ï¼ˆPDFã€Wordã€æ–‡æœ¬ç­‰ï¼‰çš„æ™ºèƒ½è§£æžï¼Œå¤§å¹…æå‡äº†æ–‡ä»¶å†…å®¹æå–çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

## ðŸ”§ ä¼˜åŒ–å†…å®¹

### 1. æ·»åŠ  LlamaIndex ä¾èµ–

**pyproject.toml æ›´æ–°**ï¼š
```toml
"llama-index-core (>=0.12.0,<0.13.0)",
"llama-index-embeddings-huggingface (>=0.5.4,<0.6.0)",
"llama-index-embeddings-instructor (>=0.3.0,<0.4.0)",
"llama-index-embeddings-ollama (>=0.6.0,<0.7.0)",
```

### 2. å¯¼å…¥å¿…è¦æ¨¡å—

**backend/services/testcase_service.py å¯¼å…¥**ï¼š
```python
import tempfile
import os
from pathlib import Path
from llama_index.core import SimpleDirectoryReader, Document
```

### 3. æ–°å¢žæ–‡ä»¶è§£æžæ–¹æ³•

**æ ¸å¿ƒæ–¹æ³• `get_document_from_files`**ï¼š
```python
async def get_document_from_files(self, files: List[FileUpload]) -> str:
    """
    ä½¿ç”¨ llama_index èŽ·å–æ–‡ä»¶å†…å®¹

    Args:
        files: æ–‡ä»¶ä¸Šä¼ å¯¹è±¡åˆ—è¡¨

    Returns:
        str: è§£æžåŽçš„æ–‡ä»¶å†…å®¹
    """
```

## ðŸ› ï¸ å®žçŽ°ç»†èŠ‚

### 1. æ–‡ä»¶å¤„ç†æµç¨‹

**å®Œæ•´çš„å¤„ç†æµç¨‹**ï¼š
```
æ–‡ä»¶ä¸Šä¼  â†’ Base64è§£ç  â†’ ä¸´æ—¶æ–‡ä»¶ä¿å­˜ â†’ LlamaIndexè§£æž â†’ å†…å®¹åˆå¹¶ â†’ è¿”å›žæ–‡æœ¬
```

**å…·ä½“æ­¥éª¤**ï¼š
1. **åˆ›å»ºä¸´æ—¶ç›®å½•**: ä½¿ç”¨ `tempfile.TemporaryDirectory()` åˆ›å»ºå®‰å…¨çš„ä¸´æ—¶å­˜å‚¨
2. **Base64è§£ç **: å°†ä¸Šä¼ çš„base64ç¼–ç æ–‡ä»¶å†…å®¹è§£ç ä¸ºäºŒè¿›åˆ¶æ•°æ®
3. **æ–‡ä»¶ç±»åž‹æŽ¨æ–­**: æ ¹æ®æ–‡ä»¶åå’Œcontent_typeæŽ¨æ–­æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å
4. **ä¸´æ—¶æ–‡ä»¶ä¿å­˜**: å°†è§£ç åŽçš„å†…å®¹ä¿å­˜ä¸ºä¸´æ—¶æ–‡ä»¶
5. **LlamaIndexè§£æž**: ä½¿ç”¨ `SimpleDirectoryReader` è¯»å–å’Œè§£æžæ–‡ä»¶å†…å®¹
6. **å†…å®¹åˆå¹¶**: ä½¿ç”¨ `Document` ç±»åˆå¹¶å¤šä¸ªæ–‡ä»¶çš„æ–‡æœ¬å†…å®¹
7. **è‡ªåŠ¨æ¸…ç†**: ä¸´æ—¶ç›®å½•è‡ªåŠ¨æ¸…ç†ï¼Œç¡®ä¿æ— æ–‡ä»¶æ®‹ç•™

### 2. æ–‡ä»¶ç±»åž‹æ”¯æŒ

**æ”¯æŒçš„æ–‡ä»¶æ ¼å¼**ï¼š
- **PDFæ–‡ä»¶**: `.pdf` - è‡ªåŠ¨æå–æ–‡æœ¬å†…å®¹
- **Wordæ–‡æ¡£**: `.docx` - è§£æžæ–‡æ¡£ç»“æž„å’Œæ–‡æœ¬
- **æ–‡æœ¬æ–‡ä»¶**: `.txt` - ç›´æŽ¥è¯»å–æ–‡æœ¬å†…å®¹
- **å…¶ä»–æ ¼å¼**: é»˜è®¤æŒ‰æ–‡æœ¬æ–‡ä»¶å¤„ç†

**æ–‡ä»¶ç±»åž‹æŽ¨æ–­é€»è¾‘**ï¼š
```python
# ç¡®å®šæ–‡ä»¶æ‰©å±•å
file_ext = Path(file.filename).suffix if file.filename else ""
if not file_ext:
    # æ ¹æ®content_typeæŽ¨æ–­æ‰©å±•å
    if "pdf" in file.content_type.lower():
        file_ext = ".pdf"
    elif "word" in file.content_type.lower() or "docx" in file.content_type.lower():
        file_ext = ".docx"
    elif "text" in file.content_type.lower():
        file_ext = ".txt"
    else:
        file_ext = ".txt"  # é»˜è®¤ä¸ºæ–‡æœ¬æ–‡ä»¶
```

### 3. é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

**å¤šå±‚å®¹é”™è®¾è®¡**ï¼š
```python
try:
    # ä½¿ç”¨ llama_index è§£æžæ–‡ä»¶å†…å®¹
    file_content = await self.get_document_from_files(message.files)
    if file_content:
        analysis_content += f"\n\nðŸ“Ž é™„ä»¶æ–‡ä»¶å†…å®¹:\n{file_content}"
        logger.success(f"   âœ… æ–‡ä»¶å†…å®¹è§£æžæˆåŠŸï¼Œå†…å®¹é•¿åº¦: {len(file_content)} å­—ç¬¦")
    else:
        logger.warning("   âš ï¸ æ–‡ä»¶å†…å®¹è§£æžä¸ºç©ºï¼Œä½¿ç”¨æ–‡ä»¶ä¿¡æ¯")
        # å›žé€€åˆ°åŽŸæ¥çš„æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
except Exception as e:
    logger.error(f"   âŒ æ–‡ä»¶è§£æžå¤±è´¥: {e}")
    # å›žé€€åˆ°åŽŸæ¥çš„æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
```

**å®¹é”™ç­–ç•¥**ï¼š
- **å•æ–‡ä»¶å¤±è´¥**: è·³è¿‡å¤±è´¥çš„æ–‡ä»¶ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
- **è§£æžå¤±è´¥**: å›žé€€åˆ°æ˜¾ç¤ºæ–‡ä»¶åŸºæœ¬ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€ç±»åž‹ã€å¤§å°ï¼‰
- **å†…å®¹ä¸ºç©º**: æä¾›è­¦å‘Šä¿¡æ¯ï¼Œä½¿ç”¨æ–‡ä»¶å…ƒä¿¡æ¯
- **å¼‚å¸¸å¤„ç†**: è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œä¸å½±å“æ•´ä½“æµç¨‹

## ðŸŽ¯ ä¼˜åŒ–æ•ˆæžœ

### 1. åŠŸèƒ½å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼ˆåŸºç¡€å®žçŽ°ï¼‰**ï¼š
```python
if message.files:
    logger.info(f"   ðŸ“Ž å¤„ç†é™„ä»¶æ–‡ä»¶: {len(message.files)} ä¸ª")
    analysis_content += f"\n\nðŸ“Ž é™„ä»¶æ–‡ä»¶ä¿¡æ¯:\n"
    analysis_content += f"æ–‡ä»¶æ€»æ•°: {len(message.files)}\n"
    for i, file in enumerate(message.files, 1):
        file_info = f"{i}. {file.filename} ({file.content_type}, {file.size} bytes)"
        analysis_content += f"{file_info}\n"
```

**ä¼˜åŒ–åŽï¼ˆLlamaIndexå®žçŽ°ï¼‰**ï¼š
```python
if message.files:
    try:
        # ä½¿ç”¨ llama_index è§£æžæ–‡ä»¶å†…å®¹
        file_content = await self.get_document_from_files(message.files)
        if file_content:
            analysis_content += f"\n\nðŸ“Ž é™„ä»¶æ–‡ä»¶å†…å®¹:\n{file_content}"
            logger.success(f"   âœ… æ–‡ä»¶å†…å®¹è§£æžæˆåŠŸï¼Œå†…å®¹é•¿åº¦: {len(file_content)} å­—ç¬¦")
        # ... å®¹é”™å¤„ç†
```

### 2. æ€§èƒ½æå‡

**å†…å®¹æå–èƒ½åŠ›**ï¼š
- âœ… **PDFæ–‡æ¡£**: å®Œæ•´æå–æ–‡æœ¬å†…å®¹ï¼ŒåŒ…æ‹¬è¡¨æ ¼å’Œæ ¼å¼åŒ–æ–‡æœ¬
- âœ… **Wordæ–‡æ¡£**: è§£æžæ–‡æ¡£ç»“æž„ï¼Œæå–æ®µè½å’Œåˆ—è¡¨å†…å®¹
- âœ… **æ–‡æœ¬æ–‡ä»¶**: ä¿æŒåŽŸå§‹æ ¼å¼å’Œç¼–ç 
- âœ… **å¤šæ–‡ä»¶åˆå¹¶**: æ™ºèƒ½åˆå¹¶å¤šä¸ªæ–‡ä»¶çš„å†…å®¹

**å¤„ç†æ•ˆçŽ‡**ï¼š
- âœ… **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šæ–‡ä»¶å¹¶å‘è§£æž
- âœ… **å†…å­˜ä¼˜åŒ–**: ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…å¤§æ–‡ä»¶å†…å­˜å ç”¨
- âœ… **è‡ªåŠ¨æ¸…ç†**: ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†ï¼Œæ— èµ„æºæ³„éœ²

### 3. ç”¨æˆ·ä½“éªŒæå‡

**æ™ºèƒ½ä½“åˆ†æžè´¨é‡**ï¼š
- âœ… **å®Œæ•´å†…å®¹**: æ™ºèƒ½ä½“å¯ä»¥åˆ†æžæ–‡ä»¶çš„å®žé™…å†…å®¹è€Œéžä»…æ–‡ä»¶å
- âœ… **ä¸Šä¸‹æ–‡ç†è§£**: åŸºäºŽæ–‡ä»¶å†…å®¹è¿›è¡Œæ·±åº¦éœ€æ±‚åˆ†æž
- âœ… **å‡†ç¡®æ€§æå‡**: æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆæ›´è´´è¿‘å®žé™…éœ€æ±‚

**é”™è¯¯å¤„ç†**ï¼š
- âœ… **ä¼˜é›…é™çº§**: è§£æžå¤±è´¥æ—¶è‡ªåŠ¨å›žé€€åˆ°åŸºç¡€ä¿¡æ¯æ˜¾ç¤º
- âœ… **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„å¤„ç†è¿‡ç¨‹æ—¥å¿—ï¼Œä¾¿äºŽé—®é¢˜å®šä½
- âœ… **ç”¨æˆ·å‹å¥½**: ä¸ä¼šå› ä¸ºæ–‡ä»¶è§£æžå¤±è´¥è€Œä¸­æ–­æ•´ä¸ªæµç¨‹

## ðŸ“‹ æŠ€æœ¯è¦ç‚¹

### 1. LlamaIndex æ ¸å¿ƒæ¦‚å¿µ

**SimpleDirectoryReader**ï¼š
- æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼çš„è‡ªåŠ¨è¯†åˆ«å’Œè§£æž
- å¯ä»¥å¤„ç†å•ä¸ªæ–‡ä»¶æˆ–æ•´ä¸ªç›®å½•
- å†…ç½®æ–‡ä»¶ç±»åž‹æ£€æµ‹å’Œç›¸åº”çš„è§£æžå™¨

**Document ç±»**ï¼š
- ç»Ÿä¸€çš„æ–‡æ¡£è¡¨ç¤ºæ ¼å¼
- æ”¯æŒæ–‡æœ¬å†…å®¹çš„åˆå¹¶å’Œå¤„ç†
- æä¾›å…ƒæ•°æ®ç®¡ç†åŠŸèƒ½

### 2. ä¸´æ—¶æ–‡ä»¶ç®¡ç†

**å®‰å…¨çš„ä¸´æ—¶æ–‡ä»¶å¤„ç†**ï¼š
```python
with tempfile.TemporaryDirectory() as temp_dir:
    temp_path = Path(temp_dir)
    # æ–‡ä»¶å¤„ç†é€»è¾‘
    # è‡ªåŠ¨æ¸…ç†ä¸´æ—¶ç›®å½•
```

**ä¼˜åŠ¿**ï¼š
- è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤
- ç³»ç»Ÿçº§ä¸´æ—¶ç›®å½•ï¼Œå®‰å…¨å¯é 
- æ”¯æŒå¹¶å‘è®¿é—®ï¼Œæ— å†²çª

### 3. å¼‚æ­¥å¤„ç†

**å¼‚æ­¥æ–¹æ³•è®¾è®¡**ï¼š
```python
async def get_document_from_files(self, files: List[FileUpload]) -> str:
    # å¼‚æ­¥æ–‡ä»¶å¤„ç†é€»è¾‘
```

**å¥½å¤„**ï¼š
- ä¸é˜»å¡žä¸»çº¿ç¨‹
- æ”¯æŒå¤§æ–‡ä»¶å¤„ç†
- ä¸ŽçŽ°æœ‰å¼‚æ­¥æž¶æž„å…¼å®¹

## ðŸš€ éªŒè¯ç»“æžœ

### 1. åŽç«¯é‡å¯æˆåŠŸ
```bash
make stop-backend && make start-backend
```

**ç»“æžœ**ï¼š
```
âœ… åŽç«¯ä¸»è¿›ç¨‹å·²åœæ­¢ (PID: 66126)
âœ… æ‰€æœ‰åŽç«¯æœåŠ¡å·²åœæ­¢
âœ… 8000 ç«¯å£å·²é‡Šæ”¾
âœ… åŽç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ (PID: 79982)
```

### 2. ä¾èµ–å®‰è£…éªŒè¯

**æ–°å¢žä¾èµ–**ï¼š
- `llama-index-core (>=0.12.0,<0.13.0)` - æ ¸å¿ƒåŠŸèƒ½
- çŽ°æœ‰çš„ embeddings ç›¸å…³ä¾èµ–ä¿æŒä¸å˜

### 3. åŠŸèƒ½é›†æˆéªŒè¯

**é›†æˆæµ‹è¯•ç‚¹**ï¼š
- âœ… **å¯¼å…¥æˆåŠŸ**: LlamaIndex æ¨¡å—æ­£ç¡®å¯¼å…¥
- âœ… **æ–¹æ³•è°ƒç”¨**: `get_document_from_files` æ–¹æ³•æ­£ç¡®é›†æˆ
- âœ… **å®¹é”™æœºåˆ¶**: é”™è¯¯å¤„ç†å’Œå›žé€€é€»è¾‘æ­£å¸¸å·¥ä½œ
- âœ… **æ—¥å¿—è¾“å‡º**: è¯¦ç»†çš„å¤„ç†è¿‡ç¨‹æ—¥å¿—

## ðŸ” ä½¿ç”¨ç¤ºä¾‹

### 1. æ–‡ä»¶ä¸Šä¼ æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
```bash
curl -X 'POST' \
  'http://localhost:8000/api/testcase/generate/streaming' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "conversation_id": "test123",
  "text_content": "æµ‹è¯•éœ€æ±‚",
  "files": [
    {
      "filename": "requirements.pdf",
      "content_type": "application/pdf",
      "size": 1024,
      "content": "base64ç¼–ç çš„PDFå†…å®¹"
    }
  ],
  "round_number": 1,
  "enable_streaming": true
}'
```

**é¢„æœŸæ•ˆæžœ**ï¼š
- PDFæ–‡ä»¶å†…å®¹è¢«å®Œæ•´æå–
- æ™ºèƒ½ä½“åŸºäºŽæ–‡ä»¶å®žé™…å†…å®¹è¿›è¡Œéœ€æ±‚åˆ†æž
- ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹æ›´å‡†ç¡®å’Œå…¨é¢

### 2. æ—¥å¿—è¾“å‡ºç¤ºä¾‹

**æˆåŠŸè§£æžæ—¥å¿—**ï¼š
```
ðŸ“„ [æ–‡ä»¶è§£æž] å¼€å§‹ä½¿ç”¨llama_indexè§£æžæ–‡ä»¶ | æ–‡ä»¶æ•°é‡: 1
   ðŸ“ å¤„ç†æ–‡ä»¶ 1: requirements.pdf (application/pdf, 1024 bytes)
   âœ… æ–‡ä»¶ä¿å­˜æˆåŠŸ: /tmp/tmpxxx/file_1.pdf
   ðŸ” ä½¿ç”¨SimpleDirectoryReaderè¯»å–æ–‡ä»¶å†…å®¹
   âœ… æ–‡ä»¶è§£æžå®Œæˆ | æ€»å†…å®¹é•¿åº¦: 2048 å­—ç¬¦
   ðŸ“„ è§£æžå†…å®¹é¢„è§ˆ: è¿™æ˜¯ä¸€ä¸ªå…³äºŽç”¨æˆ·ç™»å½•åŠŸèƒ½çš„éœ€æ±‚æ–‡æ¡£...
âœ… æ–‡ä»¶å†…å®¹è§£æžæˆåŠŸï¼Œå†…å®¹é•¿åº¦: 2048 å­—ç¬¦
```

## âœ… æ€»ç»“

LlamaIndexæ–‡ä»¶è§£æžä¼˜åŒ–å·²å®Œæˆï¼š

1. **âœ… æ ¸å¿ƒåŠŸèƒ½å®žçŽ°**: ä½¿ç”¨ LlamaIndex å®žçŽ°æ™ºèƒ½æ–‡ä»¶è§£æž
2. **âœ… å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒ PDFã€Wordã€æ–‡æœ¬ç­‰å¤šç§æ–‡ä»¶æ ¼å¼
3. **âœ… å®¹é”™æœºåˆ¶å®Œå–„**: å¤šå±‚é”™è¯¯å¤„ç†ï¼Œä¼˜é›…é™çº§
4. **âœ… æ€§èƒ½ä¼˜åŒ–**: ä¸´æ—¶æ–‡ä»¶ç®¡ç†ï¼Œå†…å­˜ä¼˜åŒ–
5. **âœ… é›†æˆéªŒè¯**: ä¸ŽçŽ°æœ‰ç³»ç»Ÿå®Œç¾Žé›†æˆ

çŽ°åœ¨ `RequirementAnalysisAgent` å¯ä»¥æ™ºèƒ½è§£æžä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ï¼Œä¸ºæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆæä¾›æ›´å‡†ç¡®çš„éœ€æ±‚åŸºç¡€ï¼

---

**ç›¸å…³æ–‡æ¡£**:
- [åŽç«¯SSEå‰ç¼€ç¼ºå¤±ä¿®å¤](./BACKEND_SSE_PREFIX_FIX.md)
- [åŽç«¯æ—¥å¿—stdoutæ··å…¥SSEæµä¿®å¤](./BACKEND_LOG_STDOUT_FIX.md)
- [é¡¹ç›®å¼€å‘è®°å½•](./MYWORK.md)
