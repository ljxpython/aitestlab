# ä»£ç é‡æ„æ€»ç»“

## é‡æ„æ¦‚è¿°

æœ¬æ¬¡é‡æ„ä¸»è¦è§£å†³äº†backend/core/init_app.pyå’Œbackend/core/database.pyä¸­çš„ä»£ç é‡å¤é—®é¢˜ï¼Œå¹¶ç»Ÿä¸€ä½¿ç”¨backend/conf/constants.pyä¸­å®šä¹‰çš„è·¯å¾„å˜é‡ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§ã€‚

## é‡æ„ç›®æ ‡

### 1. æ¶ˆé™¤ä»£ç é‡å¤
- åˆå¹¶init_app.pyå’Œdatabase.pyä¸­é‡å¤çš„æ•°æ®åº“åˆå§‹åŒ–ä»£ç 
- ç»Ÿä¸€æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘åˆ°database.pyä¸­

### 2. ç»Ÿä¸€è·¯å¾„ç®¡ç†
- ä½¿ç”¨backend/conf/constants.pyä¸­å®šä¹‰çš„backend_pathå˜é‡
- é¿å…ç¡¬ç¼–ç è·¯å¾„ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§

### 3. æ”¹è¿›ä»£ç ç»“æ„
- æ˜ç¡®å„æ¨¡å—çš„èŒè´£åˆ†å·¥
- æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§

## é‡æ„å†…å®¹

### ğŸ”§ 1. database.py é‡æ„

#### è·¯å¾„å˜é‡ç»Ÿä¸€
```python
# é‡æ„å‰
DATABASE_URL = settings.get("DATABASE_URL", "sqlite://./data/aitestlab.db")

# é‡æ„å
from backend.conf.constants import backend_path

data_dir = backend_path / "data"
db_file = data_dir / "aitestlab.db"
DATABASE_URL = settings.get("DATABASE_URL", f"sqlite://{db_file}")
```

#### åŠŸèƒ½åˆå¹¶
```python
# æ–°å¢ï¼šä»init_app.pyè¿ç§»çš„init_dataå‡½æ•°
async def init_data():
    """åˆå§‹åŒ–åº”ç”¨æ•°æ® - ä»init_app.pyè¿ç§»è¿‡æ¥"""
    logger.info("å¼€å§‹åˆå§‹åŒ–åº”ç”¨æ•°æ®...")

    try:
        # åˆå§‹åŒ–æ•°æ®åº“
        logger.debug("åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...")
        await init_db()

        # é¢„çƒ­ç¼“å­˜
        logger.debug("é¢„çƒ­åº”ç”¨ç¼“å­˜...")
        # è¿™é‡Œå¯ä»¥æ·»åŠ ç¼“å­˜é¢„çƒ­é€»è¾‘

        # æ£€æŸ¥å¤–éƒ¨æœåŠ¡è¿æ¥
        logger.debug("æ£€æŸ¥å¤–éƒ¨æœåŠ¡è¿æ¥...")
        # è¿™é‡Œå¯ä»¥æ·»åŠ å¤–éƒ¨æœåŠ¡æ£€æŸ¥é€»è¾‘

        logger.success("ğŸš€ åº”ç”¨æ•°æ®åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        logger.error(f"åº”ç”¨æ•°æ®åˆå§‹åŒ–å¤±è´¥: {e}")
        raise
```

#### è·¯å¾„å¤„ç†ä¼˜åŒ–
```python
# é‡æ„å‰
db_dir = os.path.dirname(DATABASE_URL.replace("sqlite://", ""))
if db_dir and not os.path.exists(db_dir):
    os.makedirs(db_dir, exist_ok=True)

# é‡æ„å
logger.info(f"æ•°æ®ç›®å½•: {data_dir}")
if not data_dir.exists():
    data_dir.mkdir(parents=True, exist_ok=True)
    logger.info(f"åˆ›å»ºæ•°æ®ç›®å½•: {data_dir}")
```

### ğŸ”„ 2. init_app.py ç®€åŒ–

#### ç§»é™¤é‡å¤ä»£ç 
```python
# é‡æ„å‰
async def init_data():
    """Initialize application data"""
    logger.info("å¼€å§‹åˆå§‹åŒ–åº”ç”¨æ•°æ®...")

    try:
        # åˆå§‹åŒ–æ•°æ®åº“
        logger.debug("åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...")
        from backend.core.database import init_db
        await init_db()

        # ç¤ºä¾‹ï¼šé¢„çƒ­ç¼“å­˜
        logger.debug("é¢„çƒ­åº”ç”¨ç¼“å­˜...")

        # ç¤ºä¾‹ï¼šæ£€æŸ¥å¤–éƒ¨æœåŠ¡è¿æ¥
        logger.debug("æ£€æŸ¥å¤–éƒ¨æœåŠ¡è¿æ¥...")

        logger.success("ğŸš€ åº”ç”¨æ•°æ®åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        logger.error(f"åº”ç”¨æ•°æ®åˆå§‹åŒ–å¤±è´¥: {e}")
        raise

# é‡æ„å
async def init_data():
    """Initialize application data"""
    logger.info("å¼€å§‹åˆå§‹åŒ–åº”ç”¨æ•°æ®...")

    try:
        # ä½¿ç”¨database.pyä¸­çš„ç»Ÿä¸€åˆå§‹åŒ–å‡½æ•°
        from backend.core.database import init_data as db_init_data
        await db_init_data()

        logger.success("ğŸš€ åº”ç”¨æ•°æ®åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        logger.error(f"åº”ç”¨æ•°æ®åˆå§‹åŒ–å¤±è´¥: {e}")
        raise
```

### ğŸ“ 3. init_db.py è„šæœ¬ä¼˜åŒ–

#### ç®€åŒ–è„šæœ¬é€»è¾‘
```python
# é‡æ„å‰ï¼šåŒ…å«å®Œæ•´çš„æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘
async def init_database():
    """åˆå§‹åŒ–æ•°æ®åº“"""
    try:
        # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
        db_dir = os.path.dirname(DATABASE_URL.replace("sqlite://", ""))
        # ... å¤§é‡é‡å¤ä»£ç 

# é‡æ„åï¼šä½¿ç”¨database.pyä¸­çš„ç»Ÿä¸€å‡½æ•°
async def init_database():
    """åˆå§‹åŒ–æ•°æ®åº“ - ä½¿ç”¨database.pyä¸­çš„ç»Ÿä¸€å‡½æ•°"""
    close_db = None
    try:
        from backend.core.database import init_data, close_db

        logger.info("å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...")
        await init_data()
        logger.success("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")

    except Exception as e:
        logger.error(f"æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: {e}")
        raise
    finally:
        if close_db:
            await close_db()
```

#### è·¯å¾„å¯¼å…¥ä¿®å¤
```python
# é‡æ„å‰
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# é‡æ„å
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)
```

## é‡æ„æ•ˆæœ

### âœ… ä»£ç é‡å¤æ¶ˆé™¤
- **é‡å¤ä»£ç å‡å°‘**: ç§»é™¤äº†init_app.pyä¸­é‡å¤çš„æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘
- **ç»Ÿä¸€å…¥å£**: æ‰€æœ‰æ•°æ®åº“ç›¸å…³æ“ä½œç»Ÿä¸€åœ¨database.pyä¸­ç®¡ç†
- **ç»´æŠ¤ç®€åŒ–**: æ•°æ®åº“é€»è¾‘ä¿®æ”¹åªéœ€åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œ

### âœ… è·¯å¾„ç®¡ç†ç»Ÿä¸€
- **å¸¸é‡ä½¿ç”¨**: ç»Ÿä¸€ä½¿ç”¨backend/conf/constants.pyä¸­çš„backend_path
- **è·¯å¾„ä¸€è‡´**: é¿å…äº†ç¡¬ç¼–ç è·¯å¾„å¸¦æ¥çš„ç»´æŠ¤é—®é¢˜
- **å¯ç§»æ¤æ€§**: æé«˜äº†ä»£ç çš„å¯ç§»æ¤æ€§å’Œç¯å¢ƒé€‚åº”æ€§

### âœ… ä»£ç ç»“æ„ä¼˜åŒ–
- **èŒè´£æ¸…æ™°**: database.pyä¸“æ³¨æ•°æ®åº“ç›¸å…³åŠŸèƒ½
- **æ¨¡å—åŒ–**: å„æ¨¡å—èŒè´£åˆ†å·¥æ˜ç¡®
- **å¯è¯»æ€§**: ä»£ç ç»“æ„æ›´åŠ æ¸…æ™°æ˜“æ‡‚

## æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
```
backend/core/database.py        # ä¸»è¦é‡æ„æ–‡ä»¶
â”œâ”€â”€ æ·»åŠ è·¯å¾„å˜é‡ä½¿ç”¨
â”œâ”€â”€ åˆå¹¶init_dataå‡½æ•°
â”œâ”€â”€ ä¼˜åŒ–è·¯å¾„å¤„ç†é€»è¾‘
â””â”€â”€ æ”¹è¿›æ—¥å¿—è¾“å‡º

backend/core/init_app.py        # ç®€åŒ–æ–‡ä»¶
â”œâ”€â”€ ç§»é™¤é‡å¤çš„æ•°æ®åº“åˆå§‹åŒ–ä»£ç 
â”œâ”€â”€ ä½¿ç”¨database.pyä¸­çš„ç»Ÿä¸€å‡½æ•°
â””â”€â”€ ä¿æŒåŸæœ‰æ¥å£ä¸å˜

backend/init_db.py              # è„šæœ¬ä¼˜åŒ–
â”œâ”€â”€ ä¿®å¤æ¨¡å—å¯¼å…¥è·¯å¾„
â”œâ”€â”€ ä½¿ç”¨ç»Ÿä¸€çš„åˆå§‹åŒ–å‡½æ•°
â””â”€â”€ ç®€åŒ–è„šæœ¬é€»è¾‘
```

### ä¾èµ–å…³ç³»
```
init_app.py
    â†“ è°ƒç”¨
database.py::init_data()
    â†“ è°ƒç”¨
database.py::init_db()
    â†“ è°ƒç”¨
database.py::create_default_user()

init_db.py
    â†“ ç›´æ¥è°ƒç”¨
database.py::init_data()
```

## é…ç½®å˜æ›´

### è·¯å¾„é…ç½®
```python
# constants.pyä¸­çš„è·¯å¾„å®šä¹‰
backend_path = Path(__file__).parent.parent

# database.pyä¸­çš„ä½¿ç”¨
data_dir = backend_path / "data"
db_file = data_dir / "aitestlab.db"
DATABASE_URL = settings.get("DATABASE_URL", f"sqlite://{db_file}")
```

### æ•°æ®åº“é…ç½®
```yaml
# settings.yamlä¸­ä¿æŒä¸å˜ï¼Œä½œä¸ºé»˜è®¤å€¼
DATABASE_URL: "sqlite://./data/aitestlab.db"
```

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•
- âœ… æ•°æ®åº“åˆå§‹åŒ–æ­£å¸¸
- âœ… é»˜è®¤ç”¨æˆ·åˆ›å»ºæˆåŠŸ
- âœ… åº”ç”¨å¯åŠ¨æ­£å¸¸
- âœ… è·¯å¾„è§£ææ­£ç¡®

### å…¼å®¹æ€§æµ‹è¯•
- âœ… åŸæœ‰APIæ¥å£ä¸å˜
- âœ… é…ç½®æ–‡ä»¶å…¼å®¹
- âœ… å¯åŠ¨æµç¨‹ä¸å˜
- âœ… æ•°æ®åº“ç»“æ„ä¸å˜

## æœ€ä½³å®è·µ

### 1. ä»£ç é‡æ„åŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—ä¸“æ³¨è‡ªå·±çš„èŒè´£
- **DRYåŸåˆ™**: é¿å…é‡å¤ä»£ç 
- **é…ç½®ç»Ÿä¸€**: ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç®¡ç†

### 2. è·¯å¾„ç®¡ç†
- **å¸¸é‡å®šä¹‰**: åœ¨constants.pyä¸­å®šä¹‰è·¯å¾„å¸¸é‡
- **ç›¸å¯¹è·¯å¾„**: ä½¿ç”¨ç›¸å¯¹è·¯å¾„æé«˜å¯ç§»æ¤æ€§
- **è·¯å¾„éªŒè¯**: åœ¨ä½¿ç”¨å‰éªŒè¯è·¯å¾„å­˜åœ¨æ€§

### 3. é”™è¯¯å¤„ç†
- **å¼‚å¸¸æ•è·**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ“ä½œæ—¥å¿—
- **ä¼˜é›…é™çº§**: å¤±è´¥æ—¶çš„ä¼˜é›…å¤„ç†

## åç»­ä¼˜åŒ–å»ºè®®

### 1. è¿›ä¸€æ­¥æ¨¡å—åŒ–
- è€ƒè™‘å°†ç”¨æˆ·åˆ›å»ºé€»è¾‘ç‹¬ç«‹æˆå•ç‹¬çš„æœåŠ¡
- æ•°æ®åº“è¿ç§»é€»è¾‘å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡

### 2. é…ç½®ç®¡ç†ä¼˜åŒ–
- è€ƒè™‘ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é…ç½®
- æ·»åŠ é…ç½®éªŒè¯æœºåˆ¶

### 3. æµ‹è¯•è¦†ç›–
- æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–é‡æ„çš„ä»£ç 
- é›†æˆæµ‹è¯•éªŒè¯æ•´ä½“åŠŸèƒ½

## æ€»ç»“

æœ¬æ¬¡é‡æ„æˆåŠŸå®ç°äº†ï¼š

ğŸ¯ **ä»£ç è´¨é‡æå‡**: æ¶ˆé™¤é‡å¤ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§
ğŸ”§ **æ¶æ„ä¼˜åŒ–**: æ˜ç¡®æ¨¡å—èŒè´£ï¼Œæ”¹å–„ä»£ç ç»“æ„
ğŸ“ **è·¯å¾„ç®¡ç†**: ç»Ÿä¸€è·¯å¾„å˜é‡ä½¿ç”¨ï¼Œæé«˜ä¸€è‡´æ€§
ğŸš€ **åŠŸèƒ½ä¿æŒ**: ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜ï¼Œç¡®ä¿å…¼å®¹æ€§

é‡æ„åçš„ä»£ç æ›´åŠ æ¸…æ™°ã€å¯ç»´æŠ¤ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚
